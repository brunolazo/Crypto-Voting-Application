<!DOCTYPE html>
<html>
<head>
    <title> Votazioni </title>
    <meta charset="utf-8" />

    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.ethers.io/scripts/ethers-v4.min.js" charset="utf-8" type="text/javascript"></script>

</head>
<body class="container">

    <script>

        window.onload = function () {

            getvotes();
        }
        function getvotes() {
            abi = [
                {
                    "inputs": [
                        {
                            "internalType": "string[]",
                            "name": "proposalNames",
                            "type": "string[]"
                        },
                        {
                            "internalType": "uint256",
                            "name": "tokenQuantita_",
                            "type": "uint256"
                        },
                        {
                            "internalType": "address",
                            "name": "token",
                            "type": "address"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "proposal",
                            "type": "uint256"
                        }
                    ],
                    "name": "vote",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "name": "proposals",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        },
                        {
                            "internalType": "uint256",
                            "name": "voteCount",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "name": "voters",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "vote",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "winnerName",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "winnerName_",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "winningProposal",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "winningProposal_",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ]

            const provider = new ethers.providers.Web3Provider(web3.currentProvider);

            contract = new ethers.Contract("0xf98Cb095a0Ab25c34f383cBD1a8A101Fa49DE5BC", abi, provider);
            var proposal1 = contract.proposals(0);
            proposal1.then(function (result) {
                document.getElementById("nome1").innerHTML = result[0];
                document.getElementById("voti1").innerHTML = result[1];
            });

            var proposal2 = contract.proposals(1);
            proposal2.then(function (result) {
                document.getElementById("nome2").innerHTML = result[0];
                document.getElementById("voti2").innerHTML = result[1];
            });

            var proposal3 = contract.proposals(2);
            proposal3.then(function (result) {
                document.getElementById("nome3").innerHTML = result[0];
                document.getElementById("voti3").innerHTML = result[1];
            });
            //let result = await contract.winnerName();
            //alert(result);

            //await provider.send('eth_requestAccounts', []);
            const signer = provider.getSigner()
            abiMio = [
                {
                    "constant": true,
                    "inputs": [],
                    "name": "name",
                    "outputs": [
                        {
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "name": "_spender",
                            "type": "address"
                        },
                        {
                            "name": "_value",
                            "type": "uint256"
                        }
                    ],
                    "name": "approve",
                    "outputs": [
                        {
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "totalSupply",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "name": "_from",
                            "type": "address"
                        },
                        {
                            "name": "_to",
                            "type": "address"
                        },
                        {
                            "name": "_value",
                            "type": "uint256"
                        }
                    ],
                    "name": "transferFrom",
                    "outputs": [
                        {
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "decimals",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint8"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "name": "_owner",
                            "type": "address"
                        }
                    ],
                    "name": "balanceOf",
                    "outputs": [
                        {
                            "name": "balance",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "symbol",
                    "outputs": [
                        {
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "name": "_to",
                            "type": "address"
                        },
                        {
                            "name": "_value",
                            "type": "uint256"
                        }
                    ],
                    "name": "transfer",
                    "outputs": [
                        {
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "name": "_owner",
                            "type": "address"
                        },
                        {
                            "name": "_spender",
                            "type": "address"
                        }
                    ],
                    "name": "allowance",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "payable": true,
                    "stateMutability": "payable",
                    "type": "fallback"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": true,
                            "name": "owner",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "name": "spender",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "name": "value",
                            "type": "uint256"
                        }
                    ],
                    "name": "Approval",
                    "type": "event"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": true,
                            "name": "from",
                            "type": "address"
                        },
                        {
                            "indexed": true,
                            "name": "to",
                            "type": "address"
                        },
                        {
                            "indexed": false,
                            "name": "value",
                            "type": "uint256"
                        }
                    ],
                    "name": "Transfer",
                    "type": "event"
                }
            ]

            contractMio = new ethers.Contract("0xf99980dAF477d1Df093233Ef698D1beD1c191A42", abiMio, signer);

            const num256 = 1 * 10 ** 18;
            const importo = num256.toString();
            contractMio.approve("0xf98Cb095a0Ab25c34f383cBD1a8A101Fa49DE5BC", importo);
        }

        async function vote() {
            abi = [
                {
                    "inputs": [
                        {
                            "internalType": "string[]",
                            "name": "proposalNames",
                            "type": "string[]"
                        },
                        {
                            "internalType": "uint256",
                            "name": "tokenQuantita_",
                            "type": "uint256"
                        },
                        {
                            "internalType": "address",
                            "name": "token",
                            "type": "address"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "proposal",
                            "type": "uint256"
                        }
                    ],
                    "name": "vote",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "name": "proposals",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        },
                        {
                            "internalType": "uint256",
                            "name": "voteCount",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "name": "voters",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "vote",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "winnerName",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "winnerName_",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "winningProposal",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "winningProposal_",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ]
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send('eth_requestAccounts', []);
            const signer = provider.getSigner()

            contract = new ethers.Contract("0xf98Cb095a0Ab25c34f383cBD1a8A101Fa49DE5BC", abi, signer);

            var proposalval = document.getElementById("ProposalSelect").value;

            //var castvote =
            await contract.vote(proposalval);

            //castvote.then(function (transaction) {
                alert("Votazione con successo");
                //document.getElementById("metamask").innerHTML = "Votazione effettuata con successo";
           // });
        }

    </script>
    <div id="metamask"></div>
    <h1>Votazioni</h1>
    <div class="table-responsive">
        <table class="table table-bordered">
            <thread>
                <tr>
                    <th>Candidati</th>
                    <th>Voti</th>
                </tr>
            </thread>
            <tbody>
                <tr>
                    <td id="nome1"></td>
                    <td id="voti1"></td>
                </tr>
                <tr>
                    <td id="nome2"></td>
                    <td id="voti2"></td>
                </tr>
                <tr>
                    <td id="nome3"></td>
                    <td id="voti3"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <select id="ProposalSelect">
        <option value="-1">--Selezionare candidato da votare--</option>
        <option value="0">Mickey Mouse</option>
        <option value="1">Donald Duck</option>
        <option value="2">Goofy</option>
    </select>
    <input id="pulsante1" type="button" onclick="vote()" class="btn btn-info" value="Vota" />

</body>
</html>